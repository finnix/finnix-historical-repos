#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEB_BUILD_ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)

NUMJOBS=1
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

%:
	dh $@

override_dh_auto_build:
	$(MAKE) -j$(NUMJOBS)

override_dh_auto_install: install-common install-$(DEB_BUILD_ARCH)

install-common:
	install -m 0755 -d $(CURDIR)/debian/neale-master
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix
	install -m 0644 arch.map $(CURDIR)/debian/neale-master/finnix/arch.map
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix/arch
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot

install-i386:
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix/arch/x86
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/x86
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/x86/pxelinux
	install -m 0644 splash.png $(CURDIR)/debian/neale-master/boot/x86/splash.png
	install -m 0644 binaries/ipxe $(CURDIR)/debian/neale-master/boot/x86/ipxe
	install -m 0644 binaries/memtest $(CURDIR)/debian/neale-master/boot/x86/memtest
	install -m 0644 binaries/sbm.imz $(CURDIR)/debian/neale-master/boot/x86/sbm.imz
	install -m 0644 binaries/dos.imz $(CURDIR)/debian/neale-master/boot/x86/dos.imz

install-amd64:
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix/arch/amd64
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/amd64
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/amd64/pxelinux
	install -m 0644 splash.png $(CURDIR)/debian/neale-master/boot/amd64/splash.png
	install -m 0644 binaries/ipxe $(CURDIR)/debian/neale-master/boot/amd64/ipxe
	install -m 0644 binaries/memtest $(CURDIR)/debian/neale-master/boot/amd64/memtest
	install -m 0644 binaries/sbm.imz $(CURDIR)/debian/neale-master/boot/amd64/sbm.imz
	install -m 0644 binaries/dos.imz $(CURDIR)/debian/neale-master/boot/amd64/dos.imz

install-powerpc:
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix/arch/ppc
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/ppc
	install -m 0644 ofboot.b $(CURDIR)/debian/neale-master/boot/ppc/ofboot.b
	install -m 0644 hfs.map $(CURDIR)/debian/neale-master/boot/ppc/hfs.map

install-armhf:
	install -m 0755 -d $(CURDIR)/debian/neale-master/finnix/arch/armhf
	install -m 0755 -d $(CURDIR)/debian/neale-master/boot/armhf

override_dh_builddeb:
	dh_builddeb -- -Zxz
